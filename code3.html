<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Gregor Panič - Video Game Developer</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/highlight/github.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,200,300,600,700,900' rel='stylesheet' type='text/css'>
  </head>
  <body>

    <section class="code-samples">
      <div class="container">
        <div class="row">
        <div class="header">
          <div class="number">03</div>
          <div class="name">Object culling (Unity C#)</div>
          <div class="back"><a href="/">&laquo; Back</a></div>
        </div>
        <div class="description">
          <h3>Description</h3>
          <p>
            A culling system that activates/deactivates objects. It uses culling groups to group together objects that need to be handled the same way.
            A set number of objects are culled per frame, which means the culling operation has a minimal performance impact even with large numbers of objects,
            but it takes longer to check all objects.<br/><br/>
            The abstract class ObjectCuller lays out the general algorithm, which on every frame checks a set number of objects and activates/deactivates them
            depending on what the method IsObjectValid returns. Derived classes override the inner class CullinGroup and the Activate and Deactivate methods, 
            which allows for cullers that can handle different types of objects and use different rules to determine which objects activate/deactivate.
          </p>
          <a href="https://github.com/gpanic/code-samples/tree/master/CodeSample3/CullingSystem" class="button">GitHub</a>
        </div>
      </div>

<div class="row">
<div class="code-sample">
<h3>ObjectCuller.cs</h3>
<pre><code class="c#">using UnityEngine;
using System.Collections;
using System;

public abstract class ObjectCuller : MonoBehaviour
{

    [Serializable]
    // let a derived class determine how to determine if an object is valid
    public abstract class CullingGroup
    {
        public string groupName;
        public GameObject[] objectGroups;

        public abstract bool IsObjectValid(GameObject player, GameObject obj);
    }

    public float updateObjectsPerFrame = 1;
    private CullingGroup[] cullingGroups;
    private GameObject player;

    private int cullingGroupIndex = 0;
    private int objectGroupIndex = 0;
    private int objectIndex = 0;
    private bool cull = true;

    protected abstract void Activate(GameObject objectToActivate);
    protected abstract void Deactivate(GameObject objectToDeactivate);
    protected abstract CullingGroup[] GetCullingGroups();

    private void Start()
    {
        player = GameObject.FindGameObjectWithTag(Tags.player);
        if (player != null)
        {
            cullingGroups = GetCullingGroups();
            enabled = ValidateCullingGroups();
        }
        else
        {
            Debug.LogError("No player object exists");
            enabled = false;
        }
    }

    private void Update()
    {
        if (!cull) return;

        // we can update as many objects per frame as we want, a tradeoff between
        // activation/deactivation speed and performance
        for (int i = 0; i &lt; updateObjectsPerFrame; ++i)
        {
            CullingGroup cullingGroup = cullingGroups[cullingGroupIndex];
            GameObject objectGroup = cullingGroup.objectGroups[objectGroupIndex];
            Transform obj = objectGroup.transform.GetChild(objectIndex);

            if (cullingGroup.IsObjectValid(player, obj.gameObject))
            {
                Deactivate(obj.gameObject);
            }
            else
            {
                Activate(obj.gameObject);
            }

            // update and wrap culling group, object group and object indices
            ++objectIndex;
            if (objectIndex &gt;= objectGroup.transform.childCount)
            {
                objectIndex = 0;
                ++objectGroupIndex;
            }

            if (objectGroupIndex &gt;= cullingGroup.objectGroups.Length)
            {
                objectGroupIndex = 0;
                ++cullingGroupIndex;
                cullingGroupIndex %= cullingGroups.Length;
            }
        }
    }

    public void StopCulling()
    {
        foreach (CullingGroup group in cullingGroups)
        {
            foreach (GameObject objectGroup in group.objectGroups)
            {
                foreach (Transform obj in objectGroup.transform)
                {
                    Activate(obj.gameObject);
                }
            }
        }
        cull = false;
    }

    public void StartCulling()
    {
        cull = true;
    }

    // doesn't allow empty culling groups or object groups so as to not waste time
    private bool ValidateCullingGroups()
    {
        if (cullingGroups.Length == 0)
        {
            Debug.LogError("Script requires at least one culling group.");
            return false;
        }
        else
        {
            foreach (CullingGroup cullingGroup in cullingGroups)
            {
                if (cullingGroup.objectGroups.Length == 0)
                {
                    Debug.LogError("A culling group contains no object groups.");
                    return false;
                }
                else
                {
                    foreach (GameObject objectGroup in cullingGroup.objectGroups)
                    {
                        if (objectGroup.transform.childCount == 0)
                        {
                            Debug.LogError("An object group contains no child objects.");
                            return false;
                        }
                    }
                }
            }
        }
        return true;
    }
}
</code></pre>
</div>
</div>

<div class="row">
<div class="code-sample">
<h3>DistanceCuller.cs</h3>
<pre><code class="c#">using UnityEngine;
using System.Collections;
using System;

public abstract class DistanceCuller : ObjectCuller
{
    [Serializable]
    public class DistanceCullingGroup : ObjectCuller.CullingGroup
    {
        public float drawDistance = 350.0f;

        public override bool IsObjectValid(GameObject player, GameObject obj)
        {
            return Vector3.Distance(player.transform.position, obj.transform.position)
                &gt; drawDistance;
        }
    }

    public DistanceCullingGroup[] cullingGroups;

    protected override CullingGroup[] GetCullingGroups()
    {
        return cullingGroups;
    }
}
</code></pre>
</div>
</div>

<div class="row">
<div class="code-sample">
<h3>ParticleSystemCuller.cs</h3>
<pre><code class="c#">using UnityEngine;
using System.Collections;
using System;

public class ParticleSystemCuller : DistanceCuller
{
    protected override void Activate(GameObject objectToActivate)
    {
        ParticleSystem particleSystem = objectToActivate.GetComponent&lt;ParticleSystem&gt;();
        if (particleSystem != null && particleSystem.isStopped)
        {
            particleSystem.Play();
        }
    }

    protected override void Deactivate(GameObject objectToDeactivate)
    { 
        ParticleSystem particleSystem = objectToDeactivate.GetComponent&lt;ParticleSystem&gt;();
        if (particleSystem != null && particleSystem.isPlaying)
        {
            particleSystem.Stop();
        }
    }
}
</code></pre>
</div>
</div>

<div class="back"><a href="/">&laquo; Back</a></div>
        </section>
      </div>
    </div>

    <section class="footer">
      <div class="social">
        <a href="mailto:gregor.panic@gmail.com">
          <img src="images/email_circle.png">
        </a>
        <a href="https://github.com/gpanic">
          <img src="images/github_circle.png">
        </a>
        <a href="https://si.linkedin.com/in/gregorpanic">
          <img src="images/linkedin_circle.png">
        </a>
      </div>
      &copy;2015 Gregor Panič
    </section>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/highlight.pack.js"></script> 
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>